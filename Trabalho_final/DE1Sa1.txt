#define _DEFAULT_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <stdint.h>
#include <linux/i2c-dev.h>
#include <sys/ioctl.h>
#include <time.h>

#define BTN_LEFT_MASK 0x08 
#define BTN_RIGHT_MASK 0x01 
#define VGA_BASE_PHYS 0xC8000000
#define VGA_SPAN      0x00080000
#define SCREEN_W 320
#define SCREEN_H 240
#define VGA_STRIDE_PIXELS 512 

#define HW_REGS_BASE 0xFF200000
#define HW_REGS_SPAN 0x00200000
#define KEYS_OFFSET      0x00000050
#define HEX3_HEX0_OFFSET 0x00000020
#define HEX5_HEX4_OFFSET 0x00000030

// CORES
#define BLUE    0x001F
#define GREEN_D 0x03E0 
#define GREEN_L 0x07C0 
#define PURPLE  0x780F 
#define BLACK   0x0000
#define RED     0xF800
#define YELLOW  0xFFE0
#define WHITE   0xFFFF

volatile uint16_t *vga_ptr = NULL;
volatile uint32_t *keys_ptr = NULL;
volatile uint32_t *hex3_hex0_ptr = NULL;
volatile uint32_t *hex5_hex4_ptr = NULL;
int fd_i2c;

const uint8_t seg7_table[] = {0x3F, 0x06, 0x5B, 0x4F, 0x66, 0x6D, 0x7D, 0x07, 0x7F, 0x6F};

// CONSTANTES DO JOGO
#define STRIPE_H 16     
#define SQ_W 11         
#define SQ_H 25         
#define PLAYER_W 11
#define PLAYER_H 26  

uint16_t jogador1_colors[][11] = {
    {0, 0, 0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0, 0, 0}, {0, 0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0, 0}, {0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0}, {0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0}, {0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0}, {0, 0xCC6B, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xCC6B, 0}, {0, 0, 0xCC6B, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xCC6B, 0, 0}, {0, 0, 0xCC6B, 0xCC6B, 0xCC6B, 0xCC6B, 0xCC6B, 0xCC6B, 0xCC6B, 0, 0}, {0, 0, 0, 0, 0xCC6B, 0xCC6B, 0xCC6B, 0, 0, 0, 0}, {0, 0x001F, 0x001F, 0x001F, 0x0000, 0x0000, 0x0000, 0x001F, 0x001F, 0x001F, 0}, {0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F}, {0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F}, {0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F}, {0xCC6B, 0xCC6B, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0xCC6B, 0xCC6B}, {0xCC6B, 0xCC6B, 0xCC6B, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0xCC6B, 0xCC6B}, {0, 0xCC6B, 0xCC6B, 0xCC6B, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0xCC6B, 0xCC6B}, {0, 0, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0x001F, 0xCC6B, 0}, {0, 0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0, 0}, {0, 0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0, 0}, {0, 0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0, 0}, {0, 0, 0x0000, 0x0000, 0x0000, 0, 0x0000, 0x0000, 0x0000, 0, 0}, {0, 0, 0xCC6B, 0xCC6B, 0xCC6B, 0, 0xCC6B, 0xCC6B, 0xCC6B, 0, 0}, {0, 0, 0x8A00, 0x8A00, 0x8A00, 0, 0x8A00, 0x8A00, 0x8A00, 0, 0}, {0, 0, 0xCC6B, 0xCC6B, 0xCC6B, 0, 0x0000, 0x8A00, 0x0000, 0, 0}, {0, 0, 0xCC6B, 0xCC6B, 0xCC6B, 0, 0x0000, 0x0000, 0x0000, 0, 0}, {0, 0, 0x0000, 0x0000, 0x0000, 0, 0, 0, 0, 0, 0},
};

uint16_t enemy1_d1[][11] = {{0,0,0,0x0000,0x0000,0x0000,0x0000,0x0000,0,0,0}, {0,0,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0,0}, {0,0x0000,0x0000,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x0000,0x0000,0}, {0,0x0000,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x0000,0}, {0,0x8A20,0x8A20,0x8A20,0x7D7F,0x8A20,0x7D7F,0x8A20,0x8A20,0x8A20,0}, {0,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0}, {0,0,0x8A20,0x8A20,0x8A20,0xF800,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0xF800,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0,0,0x8A20,0x8A20,0x8A20,0,0,0,0}, {0,0xF800,0xF800,0xF800,0xFFFF,0xFFFF,0xFFFF,0xF800,0xF800,0xF800,0}, {0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800}, {0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800}, {0xFFFF,0xFFFF,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xFFFF,0xFFFF}, {0x8A20,0x8A20,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0x8A20,0x8A20}, {0x8A20,0x8A20,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0x8A20,0x8A20}, {0x8A20,0x8A20,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0x8A20,0x8A20}, {0x8A20,0x8A20,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0x8A20,0x8A20}, {0,0x8A20,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0x8A20,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0xF800,0xF800,0xF800,0,0xF800,0xF800,0xF800,0,0},};
uint16_t enemy2_d1[][11] = {{0,0,0,0x8A00,0x8A00,0x8A00,0x8A00,0x8A00,0,0,0}, {0,0,0x8A00,0x8A00,0x8A00,0x8A00,0x8A00,0x8A00,0x8A00,0,0}, {0,0x8A00,0x8A00,0xFDB7,0xFDB7,0xFDB7,0xFDB7,0xFDB7,0x8A00,0x8A00,0}, {0,0x8A00,0xFDB7,0xFDB7,0xFDB7,0xFDB7,0xFDB7,0xFDB7,0xFDB7,0x8A00,0}, {0,0xFDB7,0xFDB7,0xFDB7,0x05E0,0xFDB7,0x05E0,0xFDB7,0xFDB7,0xFDB7,0}, {0,0xFDB7,0xFDB7,0xFDB7,0xFDB7,0xFDB7,0xFDB7,0xFDB7,0xFDB7,0xFDB7,0}, {0,0,0xFDB7,0xFDB7,0xFDB7,0xF800,0xFDB7,0xFDB7,0xFDB7,0,0}, {0,0,0xFDB7,0xFDB7,0xFDB7,0xF800,0xFDB7,0xFDB7,0xFDB7,0,0}, {0,0,0,0,0xFDB7,0xFDB7,0xFDB7,0,0,0,0}, {0,0xF800,0xF800,0xF800,0xFFFF,0xFFFF,0xFFFF,0xF800,0xF800,0xF800,0}, {0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800}, {0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800}, {0xFFFF,0xFFFF,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xFFFF,0xFFFF}, {0xFDB7,0xFDB7,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xFDB7,0xFDB7}, {0xFDB7,0xFDB7,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xFDB7,0xFDB7}, {0xFDB7,0xFDB7,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xFDB7,0xFDB7}, {0xFDB7,0xFDB7,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xF800,0xFDB7,0xFDB7}, {0,0xFDB7,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFDB7,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0xFDB7,0xFDB7,0xFDB7,0,0xFDB7,0xFDB7,0xFDB7,0,0}, {0,0,0xFDB7,0xFDB7,0xFDB7,0,0xFDB7,0xFDB7,0xFDB7,0,0}, {0,0,0xFDB7,0xFDB7,0xFDB7,0,0xFDB7,0xFDB7,0xFDB7,0,0}, {0,0,0xFDB7,0xFDB7,0xFDB7,0,0xFDB7,0xFDB7,0xFDB7,0,0}, {0,0,0,0x0000,0x0000,0,0x0000,0x0000,0x0000,0,0},};

uint16_t enemy1_d2[][11] = {{0,0,0,0x0000,0x0000,0x0000,0x0000,0x0000,0,0,0}, {0,0,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0,0}, {0,0x0000,0x0000,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x0000,0x0000,0}, {0,0x0000,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x0000,0}, {0,0x8A20,0x8A20,0x8A20,0x7D7F,0x8A20,0x7D7F,0x8A20,0x8A20,0x8A20,0}, {0,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0}, {0,0,0x8A20,0x8A20,0x8A20,0x0000,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0x0000,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0,0,0x8A20,0x8A20,0x8A20,0,0,0,0}, {0,0x0000,0x0000,0x0000,0xFFFF,0xFFFF,0xFFFF,0x0000,0x0000,0x0000,0}, {0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000}, {0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000}, {0xFFFF,0xFFFF,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0xFFFF,0xFFFF}, {0x8A20,0x8A20,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x8A20,0x8A20}, {0x8A20,0x8A20,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x8A20,0x8A20}, {0x8A20,0x8A20,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x8A20,0x8A20}, {0x8A20,0x8A20,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x8A20,0x8A20}, {0,0x8A20,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0x8A20,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x0000,0x0000,0x0000,0,0x0000,0x0000,0x0000,0,0},};
uint16_t enemy2_d2[][11] = {{0,0,0,0x0000,0x0000,0x0000,0x0000,0x0000,0,0,0}, {0,0,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0,0}, {0,0x0000,0x0000,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x0000,0x0000,0}, {0,0x0000,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x0000,0}, {0,0x8A20,0x8A20,0x8A20,0x7D7F,0x8A20,0x7D7F,0x8A20,0x8A20,0x8A20,0}, {0,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0}, {0,0,0x8A20,0x8A20,0x8A20,0x0000,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0x0000,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0,0,0x8A20,0x8A20,0x8A20,0,0,0,0}, {0,0x0000,0x0000,0x0000,0xFFFF,0xFFFF,0xFFFF,0x0000,0x0000,0x0000,0}, {0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000}, {0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000}, {0xFFFF,0xFFFF,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0xFFFF,0xFFFF}, {0x8A20,0x8A20,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x8A20,0x8A20}, {0x8A20,0x8A20,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x8A20,0x8A20}, {0x8A20,0x8A20,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x8A20,0x8A20}, {0x8A20,0x8A20,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x8A20,0x8A20}, {0,0x8A20,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0x8A20,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0,0x0000,0x0000,0,0x0000,0x0000,0x0000,0,0},};

uint16_t enemy1_d3[][11] = {{0,0,0,0x0000,0x0000,0x0000,0x0000,0x0000,0,0,0}, {0,0,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0,0}, {0,0x0000,0x0000,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x0000,0x0000,0}, {0,0x0000,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x0000,0}, {0,0x8A20,0x8A20,0x8A20,0x7D7F,0x8A20,0x7D7F,0x8A20,0x8A20,0x8A20,0}, {0,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0}, {0,0,0x8A20,0x8A20,0x8A20,0x780F,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0x780F,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0,0,0x8A20,0x8A20,0x8A20,0,0,0,0}, {0,0x780F,0x780F,0x780F,0xFFFF,0xFFFF,0xFFFF,0x780F,0x780F,0x780F,0}, {0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F}, {0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F}, {0xFFFF,0xFFFF,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0xFFFF,0xFFFF}, {0x8A20,0x8A20,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x8A20,0x8A20}, {0x8A20,0x8A20,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x8A20,0x8A20}, {0x8A20,0x8A20,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x8A20,0x8A20}, {0x8A20,0x8A20,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x8A20,0x8A20}, {0,0x8A20,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0x8A20,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x780F,0x780F,0x780F,0,0x780F,0x780F,0x780F,0,0},};
uint16_t enemy2_d3[][11] = {{0,0,0,0x0000,0x0000,0x0000,0x0000,0x0000,0,0,0}, {0,0,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0,0}, {0,0x0000,0x0000,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x0000,0x0000,0}, {0,0x0000,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x0000,0}, {0,0x8A20,0x8A20,0x8A20,0x7D7F,0x8A20,0x7D7F,0x8A20,0x8A20,0x8A20,0}, {0,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0}, {0,0,0x8A20,0x8A20,0x8A20,0x780F,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0x780F,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0,0,0x8A20,0x8A20,0x8A20,0,0,0,0}, {0,0x780F,0x780F,0x780F,0xFFFF,0xFFFF,0xFFFF,0x780F,0x780F,0x780F,0}, {0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F}, {0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F}, {0xFFFF,0xFFFF,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0xFFFF,0xFFFF}, {0x8A20,0x8A20,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x8A20,0x8A20}, {0x8A20,0x8A20,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x8A20,0x8A20}, {0x8A20,0x8A20,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x8A20,0x8A20}, {0x8A20,0x8A20,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x780F,0x8A20,0x8A20}, {0,0x8A20,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0x8A20,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x780F,0x780F,0x780F,0,0x780F,0x780F,0x780F,0,0},};

uint16_t enemy1_d4[][11] = {{0,0,0,0x0000,0x0000,0x0000,0x0000,0x0000,0,0,0}, {0,0,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0,0}, {0,0x0000,0x0000,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x0000,0x0000,0}, {0,0x0000,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x0000,0}, {0,0x8A20,0x8A20,0x8A20,0x7D7F,0x8A20,0x7D7F,0x8A20,0x8A20,0x8A20,0}, {0,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0}, {0,0,0x8A20,0x8A20,0x8A20,0xFFE0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0xFFE0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0,0,0x8A20,0x8A20,0x8A20,0,0,0,0}, {0,0xFFE0,0xFFE0,0xFFE0,0xFFFF,0xFFFF,0xFFFF,0xFFE0,0xFFE0,0xFFE0,0}, {0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0}, {0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0}, {0xFFFF,0xFFFF,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFFF,0xFFFF}, {0x8A20,0x8A20,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0x8A20,0x8A20}, {0x8A20,0x8A20,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0x8A20,0x8A20}, {0x8A20,0x8A20,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0x8A20,0x8A20}, {0x8A20,0x8A20,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0x8A20,0x8A20}, {0,0x8A20,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0x8A20,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0xFFE0,0xFFE0,0xFFE0,0,0xFFE0,0xFFE0,0xFFE0,0,0},};
uint16_t enemy2_d4[][11] = {{0,0,0,0x0000,0x0000,0x0000,0x0000,0x0000,0,0,0}, {0,0,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0,0}, {0,0x0000,0x0000,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x0000,0x0000,0}, {0,0x0000,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x0000,0}, {0,0x8A20,0x8A20,0x8A20,0x7D7F,0x8A20,0x7D7F,0x8A20,0x8A20,0x8A20,0}, {0,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0x8A20,0}, {0,0,0x8A20,0x8A20,0x8A20,0xFFE0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0xFFE0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0,0,0x8A20,0x8A20,0x8A20,0,0,0,0}, {0,0xFFE0,0xFFE0,0xFFE0,0xFFFF,0xFFFF,0xFFFF,0xFFE0,0xFFE0,0xFFE0,0}, {0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0}, {0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0}, {0xFFFF,0xFFFF,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFFF,0xFFFF}, {0x8A20,0x8A20,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0x8A20,0x8A20}, {0x8A20,0x8A20,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0x8A20,0x8A20}, {0x8A20,0x8A20,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0x8A20,0x8A20}, {0x8A20,0x8A20,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0xFFE0,0x8A20,0x8A20}, {0,0x8A20,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0x8A20,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0xFFFF,0xFFFF,0xFFFF,0,0xFFFF,0xFFFF,0xFFFF,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0x8A20,0x8A20,0x8A20,0,0x8A20,0x8A20,0x8A20,0,0}, {0,0,0xFFE0,0xFFE0,0xFFE0,0,0xFFE0,0xFFE0,0xFFE0,0,0},};

typedef struct {
    int score_inc;
    float init_speed;
    float max_speed;
    float accel_step;
    int min_sq;
    int max_sq;
    int min_gap;
    int max_gap;
    uint16_t (*sprite1)[11]; 
    uint16_t (*sprite2)[11]; 
    uint16_t indicator_color;
} DifficultyParams;

DifficultyParams levels[4] = {
    {1, 2.0f, 5.0f, 0.0002f, 1, 3, 40, 80, enemy1_d1, enemy2_d1, RED},
    {2, 2.0f, 7.0f, 0.0004f, 1, 5, 30, 70, enemy1_d2, enemy2_d2, BLACK},
    {4, 3.0f, 8.0f, 0.0008f, 2, 6, 20, 60, enemy1_d3, enemy2_d3, PURPLE},
    {8, 4.0f, 14.0f, 0.0016f, 3, 8, 10, 50, enemy1_d4, enemy2_d4, YELLOW}
};

typedef struct {
    float y; 
    int x;
    int type;
    int active;
} Enemy;

#define MAX_ACTIVE 50 
Enemy enemies[MAX_ACTIVE];
int ecount = 0;

static unsigned int rng_state = 1;
unsigned int rand32() { 
    rng_state = rng_state * 1103515245 + 12345; 
    return (rng_state >> 16) & 0x7FFF; 
}
int rand_range(int a, int b) { 
    return a + (rand32() % (b - a + 1)); 
}

void update_score_display(int score) {
    if (score > 999999) score = 999999;
    int d0 = score % 10;
    int d1 = (score / 10) % 10;
    int d2 = (score / 100) % 10;
    int d3 = (score / 1000) % 10;
    int d4 = (score / 10000) % 10;
    int d5 = (score / 100000) % 10;

    uint32_t hex3_0_val = (seg7_table[d3] << 24) | (seg7_table[d2] << 16) | (seg7_table[d1] << 8) | (seg7_table[d0]);
    uint32_t hex5_4_val = (seg7_table[d5] << 8) | (seg7_table[d4]);

    *hex3_hex0_ptr = hex3_0_val;
    *hex5_hex4_ptr = hex5_4_val;
}

void read_accel(float *ax, float *ay) {
    uint8_t reg = 0x32; 
    if(write(fd_i2c, &reg, 1) != 1) return;
    uint8_t d[6];
    if (read(fd_i2c, d, 6) != 6) return;
    int16_t x = (d[1] << 8) | d[0];
    int16_t y = (d[3] << 8) | d[2];
    *ax = x / 256.0f;
    *ay = y / 256.0f;
    if (*ax > -0.15f && *ax < 0.15f) *ax = 0;
    if (*ay > -0.15f && *ay < 0.15f) *ay = 0;
}

void draw_row_fast(int y, uint16_t color) {
    if (y < 0 || y >= SCREEN_H) return;
    uint32_t base = y * VGA_STRIDE_PIXELS;
    for (int x = 0; x < SCREEN_W; x++) vga_ptr[base + x] = color;
}

void draw_square_solid(int y, int x, int size, uint16_t color) {
    for (int i = 0; i < size; i++) {
        int yy = y + i;
        if (yy >= SCREEN_H) break;
        uint32_t base = yy * VGA_STRIDE_PIXELS;
        for (int j = 0; j < size; j++) {
            int xx = x + j;
            if (xx < SCREEN_W) vga_ptr[base + xx] = color;
        }
    }
}

void draw_circle_solid(int cy, int cx, int radius, uint16_t color) {
    int r2 = radius * radius;
    for (int y = -radius; y <= radius; y++) {
        for (int x = -radius; x <= radius; x++) {
            if (x*x + y*y <= r2) {
                int py = cy + y;
                int px = cx + x;
                if (px >= 0 && px < SCREEN_W && py >= 0 && py < SCREEN_H) {
                    vga_ptr[py * VGA_STRIDE_PIXELS + px] = color;
                }
            }
        }
    }
}

void draw_enemy_sprite(int y, int x, uint16_t (*sprite)[11]) {
    for (int r = 0; r < SQ_H; r++) {
        int yy = y + r;
        if (yy < 0) continue;
        if (yy >= SCREEN_H) break;
        uint32_t base = yy * VGA_STRIDE_PIXELS;
        for (int c = 0; c < SQ_W; c++) {
            int xx = x + c;
            if (xx < 0 || xx >= SCREEN_W) continue;
            uint16_t color = sprite[r][c];
            if (color != 0) vga_ptr[base + xx] = color;
        }
    }
}

void draw_player_sprite(int y, int x) {
    for (int r = 0; r < PLAYER_H; r++) {
        int yy = y + r;
        if (yy < 0) continue;
        if (yy >= SCREEN_H) break;
        uint32_t base = yy * VGA_STRIDE_PIXELS;
        for (int c = 0; c < PLAYER_W; c++) { 
            int xx = x + c;
            if (xx < 0 || xx >= SCREEN_W) continue;
            uint16_t color = jogador1_colors[r][c];
            if (color != 0) vga_ptr[base + xx] = color;
        }
    }
}

int conflict(int y, int x) {
    for(int i=0; i<ecount; i++){
        if(!enemies[i].active) continue;
        int oy = (int)enemies[i].y; 
        int ox = enemies[i].x;
        if ((y < oy + SQ_H + 20) && (y + SQ_H + 20 > oy) &&
            (x < ox + SQ_W + 20) && (x + SQ_W + 20 > ox))
            return 1;
    }
    return 0;
}

void cleanup(int *current_score, float *current_speed, DifficultyParams *diff) {
    int j=0;
    for(int i=0; i<ecount; i++){
        if(enemies[i].active) {
            if(enemies[i].y > SCREEN_H) {
                enemies[i].active = 0; 
                (*current_score) += diff->score_inc; 
                update_score_display(*current_score);
                *current_speed += diff->accel_step;
                if (*current_speed > diff->max_speed) *current_speed = diff->max_speed;
            } else {
                enemies[j++] = enemies[i]; 
            }
        }
    }
    ecount = j;
}

int check_player_collision(int py, int px) {
    int hitbox_margin = 2;
    int pw = PLAYER_W - hitbox_margin;
    int ph = PLAYER_H - hitbox_margin;
    int ew = SQ_W - hitbox_margin;
    int eh = SQ_H - hitbox_margin;

    for (int i = 0; i < ecount; i++) {
        if (!enemies[i].active) continue;
        int ex = enemies[i].x;
        int ey = (int)enemies[i].y;
        if (px < ex + ew && px + pw > ex && py < ey + eh && py + ph > ey) {
            return 1; 
        }
    }
    return 0;
}

int main() {
    int fd;
    rng_state = time(NULL);

    if ((fd = open("/dev/mem", O_RDWR | O_SYNC)) == -1) return 1;

    void *vga_base_addr = mmap(NULL, VGA_SPAN, (PROT_READ | PROT_WRITE), MAP_SHARED, fd, VGA_BASE_PHYS);
    if (vga_base_addr == MAP_FAILED) { close(fd); return 1; }
    vga_ptr = (volatile uint16_t *)vga_base_addr;

    void *hps_virtual_base = mmap(NULL, HW_REGS_SPAN, (PROT_READ | PROT_WRITE), MAP_SHARED, fd, HW_REGS_BASE);
    if (hps_virtual_base == MAP_FAILED) { munmap((void*)vga_base_addr, VGA_SPAN); close(fd); return 1; }
    
    keys_ptr = (volatile uint32_t *)((char *)hps_virtual_base + KEYS_OFFSET);
    hex3_hex0_ptr = (volatile uint32_t *)((char *)hps_virtual_base + HEX3_HEX0_OFFSET);
    hex5_hex4_ptr = (volatile uint32_t *)((char *)hps_virtual_base + HEX5_HEX4_OFFSET);

    fd_i2c = open("/dev/i2c-0", O_RDWR);
    if (fd_i2c < 0) return 1;
    ioctl(fd_i2c, I2C_SLAVE, 0x53);
    uint8_t init_cmds[][2] = {{0x2D, 0x08}, {0x31, 0x08}, {0x2C, 0x0A}};
    for(int i=0; i<3; i++) write(fd_i2c, init_cmds[i], 2);

    int current_level = 0; 

    while(1) {
        printf("Tela inicial. Nivel Atual: %d\n", current_level + 1);
        update_score_display(0);
        
        for(int y = 0; y < SCREEN_H; y++) draw_row_fast(y, BLUE);
        
        draw_circle_solid(SCREEN_H/2, SCREEN_W/2, 20, levels[current_level].indicator_color);

        while (1) { 
            uint32_t k = *keys_ptr;

            if (k != 0) {
                if (k & BTN_LEFT_MASK) {
                    break;
                }
                
                else {
                    current_level++;
                    if (current_level > 3) current_level = 0;
                    
                    draw_square_solid((SCREEN_H/2)-22, (SCREEN_W/2)-22, 44, WHITE);
                    usleep(50000); 
                    draw_square_solid((SCREEN_H/2)-22, (SCREEN_W/2)-22, 44, BLUE);
                    draw_circle_solid(SCREEN_H/2, SCREEN_W/2, 20, levels[current_level].indicator_color);
                    
                    printf(">> Dificuldade alterada para: %d\n", current_level + 1);
                    fflush(stdout);

                    while ((*keys_ptr != 0) && !(*keys_ptr & BTN_LEFT_MASK)) usleep(10000);
                }
            }
            usleep(10000); 
        }
        
        while (*keys_ptr & BTN_LEFT_MASK) usleep(10000);

        DifficultyParams diff = levels[current_level];

        rng_state += time(NULL); 
        float p_x = (SCREEN_W - PLAYER_W) / 2.0f;
        float p_y = SCREEN_H - PLAYER_H - 20.0f;
        float p_speed = 6.0f;
        float current_speed = diff.init_speed;
        float world_scroll_y = 0.0f;
        float next_spawn = (float)rand_range(diff.min_gap, diff.max_gap);
        int game_running = 1;
        int score = 0;
        
        ecount = 0;
        for(int i=0; i<MAX_ACTIVE; i++) enemies[i].active = 0;

        printf("Jogo iniciado! Dif: %d\n", current_level+1);
        fflush(stdout);
        
        while(game_running){
            if (*keys_ptr & BTN_RIGHT_MASK) {
                int px = (SCREEN_W / 2) - 10;
                int py = (SCREEN_H / 2) - 10;
                draw_square_solid(py, px, 20, PURPLE);
                
                while (*keys_ptr & BTN_RIGHT_MASK) usleep(10000);
                
                while (1) {
                    uint32_t k = *keys_ptr;
                    if (k & BTN_RIGHT_MASK) {
                        while (*keys_ptr & BTN_RIGHT_MASK) usleep(10000);
                        break; 
                    }
                    if (k & BTN_LEFT_MASK) {
                        while (*keys_ptr & BTN_LEFT_MASK) usleep(10000);
                        game_running = 0; 
                        break; 
                    }
                    usleep(10000); 
                }
            }
            if (!game_running) break;

            float ax, ay;
            read_accel(&ax, &ay);
            p_x += (ax * p_speed);
            p_y -= (ay * p_speed); 
            if (p_x < 0) p_x = 0;
            if (p_x > SCREEN_W - PLAYER_W) p_x = SCREEN_W - PLAYER_W;
            if (p_y < 0) p_y = 0;
            if (p_y > SCREEN_H - PLAYER_H) p_y = SCREEN_H - PLAYER_H;

            world_scroll_y += current_speed;
            for(int i=0; i<ecount; i++) {
                if(enemies[i].active) enemies[i].y += current_speed;
            }
            
            cleanup(&score, &current_speed, &diff);

            if (check_player_collision((int)p_y, (int)p_x)) {
                printf("Game Over! Score: %d\n", score);
                usleep(500000); 
                break; 
            }

            next_spawn -= current_speed;
            if(next_spawn <= 0){
                int qty = rand_range(diff.min_sq, diff.max_sq);
                int placed=0, attempts=0;
                int spawn_y = -SQ_H - 10; 
                while(placed < qty && attempts < 100 && ecount < MAX_ACTIVE){
                    attempts++;
                    int tx = rand_range(10, SCREEN_W - SQ_W - 10); 
                    if(!conflict(spawn_y, tx)){
                        enemies[ecount].x = tx;
                        enemies[ecount].y = (float)spawn_y;
                        enemies[ecount].type = (rand32() & 1) ? 1 : 2;
                        enemies[ecount].active = 1;
                        ecount++;
                        placed++;
                    }
                }
                next_spawn = (float)rand_range(diff.min_gap, diff.max_gap);
            }

            for(int y = 0; y < SCREEN_H; y++) {
                int virtual_y = y - (int)world_scroll_y;
                int stripe_idx = (virtual_y / STRIPE_H) % 2;
                if (stripe_idx < 0) stripe_idx += 2;
                uint16_t color = (stripe_idx == 0) ? GREEN_D : GREEN_L;
                draw_row_fast(y, color);
            }

            for(int i=0; i<ecount; i++){
                if(!enemies[i].active) continue;
                uint16_t (*spr)[11] = (enemies[i].type == 1) ? diff.sprite1 : diff.sprite2;
                int ey = (int)enemies[i].y;
                int ex = enemies[i].x;
                for (int r = 0; r < SQ_H; r++) {
                    int yy = ey + r;
                    if (yy < 0) continue;
                    if (yy >= SCREEN_H) break;
                    uint32_t base = yy * VGA_STRIDE_PIXELS;
                    for (int c = 0; c < SQ_W; c++) {
                        int xx = ex + c;
                        if (xx < 0 || xx >= SCREEN_W) continue;
                        uint16_t color = spr[r][c];
                        if (color != 0) vga_ptr[base + xx] = color;
                    }
                }
            }

            for (int r = 0; r < PLAYER_H; r++) {
                int yy = (int)p_y + r;
                if (yy < 0) continue;
                if (yy >= SCREEN_H) break;
                uint32_t base = yy * VGA_STRIDE_PIXELS;
                for (int c = 0; c < PLAYER_W; c++) { 
                    int xx = (int)p_x + c;
                    if (xx < 0 || xx >= SCREEN_W) continue;
                    uint16_t color = jogador1_colors[r][c];
                    if (color != 0) vga_ptr[base + xx] = color;
                }
            }

            usleep(20000); 
        }
    }

    close(fd_i2c);
    munmap((void*)keys_ptr, HW_REGS_SPAN);
    munmap((void*)vga_base_addr, VGA_SPAN);
    close(fd);
    return 0;
}